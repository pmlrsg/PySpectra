import unittest
import os

import numpy as np
from numpy.testing import assert_allclose

from PySpectra import extract_spectra_from_file

TEST_INPUTS_DIRECTORY = os.path.join(os.path.dirname(__file__), 'inputs')


class USGSTests(unittest.TestCase):

    correct_wavelengths = np.array([ 0.2051,  0.2131,  0.2211,  0.2291,  0.2361,  0.2421,  0.2481,
            0.2536,  0.2586,  0.2636,  0.2686,  0.2731,  0.2771,  0.2811,
            0.2851,  0.2891,  0.2931,  0.2971,  0.3011,  0.3051,  0.3091,
            0.3131,  0.3171,  0.3211,  0.3251,  0.3291,  0.3331,  0.3371,
            0.3411,  0.3451,  0.3491,  0.3531,  0.3571,  0.3606,  0.3636,
            0.3666,  0.3696,  0.3726,  0.3756,  0.3786,  0.3811,  0.3831,
            0.3851,  0.3871,  0.3891,  0.3911,  0.3931,  0.3951,  0.3971,
            0.3991,  0.4011,  0.4031,  0.4051,  0.4071,  0.4091,  0.4111,
            0.4128,  0.4158,  0.4188,  0.4218,  0.4248,  0.4278,  0.4308,
            0.4338,  0.4368,  0.4398,  0.4428,  0.4458,  0.4488,  0.4513,
            0.4533,  0.4553,  0.4573,  0.4593,  0.4613,  0.4633,  0.4653,
            0.4673,  0.4693,  0.4713,  0.4733,  0.4753,  0.4773,  0.4793,
            0.4813,  0.4833,  0.4853,  0.4873,  0.4893,  0.4913,  0.4933,
            0.4953,  0.4973,  0.4993,  0.5013,  0.5033,  0.5053,  0.5073,
            0.5093,  0.5113,  0.5133,  0.5153,  0.5173,  0.5193,  0.5213,
            0.5233,  0.5253,  0.5273,  0.5293,  0.5313,  0.5333,  0.5353,
            0.5373,  0.5393,  0.5413,  0.5433,  0.5453,  0.5473,  0.5493,
            0.5513,  0.5533,  0.5553,  0.5573,  0.5593,  0.5613,  0.5633,
            0.5653,  0.5673,  0.5693,  0.5713,  0.5733,  0.5753,  0.5773,
            0.5793,  0.5813,  0.5833,  0.5853,  0.5873,  0.5893,  0.5913,
            0.5933,  0.5953,  0.5973,  0.5993,  0.6011,  0.6027,  0.6043,
            0.6059,  0.6075,  0.6091,  0.6107,  0.6123,  0.6139,  0.6155,
            0.6171,  0.6187,  0.6203,  0.6219,  0.6235,  0.6251,  0.6267,
            0.6283,  0.6299,  0.6317,  0.6337,  0.6357,  0.6377,  0.6397,
            0.6417,  0.6437,  0.6457,  0.6477,  0.6497,  0.6517,  0.6537,
            0.6557,  0.6577,  0.6597,  0.6617,  0.6637,  0.6657,  0.6677,
            0.6702,  0.6732,  0.6762,  0.6792,  0.6822,  0.6852,  0.6882,
            0.6912,  0.6942,  0.6972,  0.7002,  0.702 ,  0.704 ,  0.706 ,
            0.708 ,  0.71  ,  0.712 ,  0.714 ,  0.716 ,  0.718 ,  0.72  ,
            0.722 ,  0.724 ,  0.726 ,  0.728 ,  0.73  ,  0.732 ,  0.734 ,
            0.736 ,  0.738 ,  0.74  ,  0.742 ,  0.744 ,  0.746 ,  0.748 ,
            0.7505,  0.7535,  0.7565,  0.7595,  0.7625,  0.7655,  0.7685,
            0.7715,  0.7745,  0.7775,  0.781 ,  0.785 ,  0.789 ,  0.793 ,
            0.797 ,  0.8015,  0.8065,  0.8115,  0.8165,  0.822 ,  0.828 ,
            0.835 ,  0.843 ,  0.851 ,  0.859 ,  0.871 ,  0.883 ,  0.894 ,
            0.904 ,  0.914 ,  0.924 ,  0.933 ,  0.941 ,  0.949 ,  0.957 ,
            0.964 ,  0.97  ,  0.976 ,  0.982 ,  0.988 ,  0.994 ,  1.    ,
            1.006 ,  1.012 ,  1.018 ,  1.0235,  1.0285,  1.0335,  1.0385,
            1.0435,  1.0485,  1.0535,  1.0585,  1.0635,  1.0685,  1.0735,
            1.0785,  1.0835,  1.0885,  1.0935,  1.0985,  1.1035,  1.1085,
            1.1135,  1.1185,  1.1235,  1.1285,  1.1335,  1.1385,  1.1435,
            1.1485,  1.1535,  1.1585,  1.1635,  1.1685,  1.1735,  1.1785,
            1.1835,  1.1885,  1.1935,  1.1985,  1.2035,  1.2085,  1.2135,
            1.2185,  1.2235,  1.2285,  1.2335,  1.2385,  1.2435,  1.2485,
            1.2535,  1.2585,  1.2635,  1.2685,  1.2735,  1.2785,  1.2835,
            1.2885,  1.2935,  1.2985,  1.3035,  1.3085,  1.3135,  1.3185,
            1.3235,  1.3285,  1.3335,  1.3385,  1.3435,  1.3485,  1.3535,
            1.3585,  1.3635,  1.3685,  1.3735,  1.3785,  1.3835,  1.3885,
            1.3935,  1.3985,  1.4035,  1.4085,  1.4135,  1.4185,  1.4235,
            1.4285,  1.4335,  1.4385,  1.4435,  1.4485,  1.4535,  1.4585,
            1.4635,  1.4685,  1.4735,  1.4785,  1.4835,  1.4885,  1.4935,
            1.4985,  1.5035,  1.5085,  1.5135,  1.5185,  1.5235,  1.5285,
            1.534 ,  1.54  ,  1.546 ,  1.552 ,  1.558 ,  1.564 ,  1.5705,
            1.5775,  1.5845,  1.5915,  1.5985,  1.6055,  1.6125,  1.6195,
            1.6265,  1.6335,  1.6405,  1.6475,  1.6545,  1.6615,  1.6685,
            1.676 ,  1.684 ,  1.692 ,  1.7   ,  1.708 ,  1.716 ,  1.724 ,
            1.732 ,  1.74  ,  1.748 ,  1.756 ,  1.764 ,  1.772 ,  1.78  ,
            1.788 ,  1.796 ,  1.805 ,  1.815 ,  1.825 ,  1.835 ,  1.845 ,
            1.855 ,  1.865 ,  1.875 ,  1.885 ,  1.895 ,  1.905 ,  1.915 ,
            1.925 ,  1.935 ,  1.945 ,  1.955 ,  1.965 ,  1.975 ,  1.985 ,
            1.995 ,  2.005 ,  2.015 ,  2.025 ,  2.035 ,  2.045 ,  2.055 ,
            2.065 ,  2.075 ,  2.085 ,  2.095 ,  2.105 ,  2.115 ,  2.125 ,
            2.135 ,  2.145 ,  2.155 ,  2.165 ,  2.175 ,  2.185 ,  2.195 ,
            2.205 ,  2.215 ,  2.225 ,  2.235 ,  2.245 ,  2.255 ,  2.265 ,
            2.275 ,  2.285 ,  2.295 ,  2.305 ,  2.315 ,  2.325 ,  2.335 ,
            2.345 ,  2.355 ,  2.365 ,  2.375 ,  2.386 ,  2.4   ,  2.418 ,
            2.44  ,  2.466 ,  2.496 ,  2.528 ,  2.56  ,  2.592 ,  2.624 ,
            2.656 ,  2.688 ,  2.72  ,  2.752 ,  2.784 ,  2.816 ,  2.848 ,
            2.88  ,  2.912 ,  2.944 ,  2.976 ])

    correct_values = np.array([      np.nan,       np.nan,       np.nan,       np.nan,       np.nan,       np.nan,
                 np.nan,       np.nan,       np.nan,       np.nan,       np.nan,       np.nan,
                 np.nan,       np.nan,       np.nan,       np.nan,       np.nan,       np.nan,
                 np.nan,       np.nan,       np.nan,       np.nan,       np.nan,       np.nan,
                 np.nan,       np.nan,       np.nan,       np.nan,       np.nan,       np.nan,
                 np.nan,  0.025872,  0.025742,  0.025971,  0.026499,  0.026402,
            0.026522,  0.026954,  0.027559,  0.028331,  0.028767,  0.029585,
            0.030973,  0.03156 ,  0.032873,  0.034312,  0.035988,  0.037768,
            0.039774,  0.042787,  0.045888,  0.048787,  0.052324,  0.055953,
            0.059185,  0.063734,  0.066953,  0.072524,  0.077323,  0.081643,
            0.086048,  0.088883,  0.091914,  0.094124,  0.095967,  0.097239,
            0.098444,  0.099493,  0.100334,  0.10131 ,  0.10194 ,  0.101801,
            0.102352,  0.102322,  0.102996,  0.103498,  0.103774,  0.103542,
            0.104328,  0.103819,  0.104128,  0.104797,  0.104279,  0.104858,
            0.105134,  0.104908,  0.105409,  0.104773,  0.10508 ,  0.105354,
            0.105842,  0.106266,  0.106232,  0.106831,  0.107135,  0.107736,
            0.108097,  0.109429,  0.110059,  0.111538,  0.113872,  0.115647,
            0.118585,  0.122203,  0.125563,  0.130016,  0.13409 ,  0.13815 ,
            0.141696,  0.145375,  0.147979,  0.149625,  0.151897,  0.153029,
            0.153697,  0.15432 ,  0.154902,  0.15592 ,  0.156215,  0.156883,
            0.157067,  0.156754,  0.155825,  0.153935,  0.153614,  0.151607,
            0.149113,  0.146623,  0.143465,  0.140074,  0.137659,  0.134751,
            0.132769,  0.130579,  0.128974,  0.128324,  0.126481,  0.12674 ,
            0.125228,  0.124564,  0.124422,  0.124241,  0.124139,  0.124259,
            0.123239,  0.122722,  0.122109,  0.121719,  0.121434,  0.120613,
            0.119919,  0.119816,  0.118527,  0.118392,  0.117084,  0.116837,
            0.115966,  0.115754,  0.116061,  0.115657,  0.1158  ,  0.114972,
            0.115528,  0.114848,  0.114845,  0.114685,  0.114614,  0.113878,
            0.113839,  0.112835,  0.111964,  0.112026,  0.111829,  0.111053,
            0.110732,  0.111108,  0.109924,  0.10989 ,  0.109784,  0.109216,
            0.10866 ,  0.109086,  0.108216,  0.108962,  0.108304,  0.10825 ,
            0.108919,  0.108549,  0.110515,  0.112225,  0.118794,  0.130075,
            0.147267,  0.160715,  0.175997,  0.194053,  0.212952,  0.232377,
            0.253437,  0.275261,  0.29892 ,  0.323958,  0.350082,  0.378737,
            0.405023,  0.432658,  0.458999,  0.486158,  0.511204,  0.53465 ,
            0.557053,  0.576821,  0.595124,  0.611851,  0.626059,  0.637945,
            0.648719,  0.660617,  0.67114 ,  0.680563,  0.686598,  0.690626,
            0.693815,  0.696658,  0.699743,  0.702057,  0.702545,  0.704324,
            0.704678,  0.706172,  0.707033,  0.706897,  0.707168,  0.707788,
            0.709454,  0.709795,  0.709884,  0.710837,  0.711868,  0.712245,
            0.717522,  0.719119,  0.717994,  0.720672,  0.717683,  0.717707,
            0.714651,  0.712216,  0.713556,  0.708119,  0.701144,  0.694564,
            0.691056,  0.688739,  0.688067,  0.687839,  0.686835,  0.688102,
            0.690922,  0.692166,  0.69297 ,  0.696728,  0.699261,  0.703998,
            0.70326 ,  0.704904,  0.70615 ,  0.707297,  0.709063,  0.710249,
            0.708735,  0.710158,  0.711537,  0.710194,  0.708609,  0.708731,
            0.708166,  0.70731 ,  0.707163,  0.704392,  0.704472,  0.701425,
            0.700272,  0.695234,  0.69005 ,  0.67972 ,  0.667087,  0.655266,
            0.644703,  0.637114,  0.632256,  0.631087,  0.62882 ,  0.625224,
            0.624276,  0.624387,  0.622401,  0.621721,  0.6214  ,  0.621982,
            0.623514,  0.624964,  0.626245,  0.629116,  0.631549,  0.631559,
            0.635453,  0.63542 ,  0.63647 ,  0.637533,  0.638961,  0.63746 ,
            0.638771,  0.636709,  0.635207,  0.632961,  0.631542,  0.626558,
            0.622868,  0.616499,  0.61157 ,  0.602564,  0.592556,  0.582642,
            0.571585,  0.560078,  0.5493  ,  0.538384,  0.530439,  0.523128,
            0.512681,  0.503286,  0.486714,  0.466509,  0.434691,  0.397113,
            0.359509,  0.319977,  0.287171,  0.26182 ,  0.244808,  0.232743,
            0.224066,  0.216948,  0.212156,  0.207879,  0.206021,  0.203644,
            0.204705,  0.203925,  0.205754,  0.208589,  0.210765,  0.217543,
            0.22247 ,  0.228899,  0.235126,  0.242205,  0.248938,  0.257792,
            0.264813,  0.273406,  0.282295,  0.289506,  0.29823 ,  0.307398,
            0.316634,  0.325694,  0.333475,  0.340874,  0.348345,  0.357002,
            0.365253,  0.372246,  0.379038,  0.386089,  0.391493,  0.396786,
            0.401947,  0.405383,  0.409473,  0.41377 ,  0.416662,  0.41813 ,
            0.415846,  0.415669,  0.412172,  0.409874,  0.40836 ,  0.404308,
            0.398456,  0.392084,  0.387966,  0.385279,  0.380131,  0.371436,
            0.363904,  0.359526,  0.356855,  0.358014,  0.354299,  0.354683,
            0.355837,  0.354668,  0.353913,  0.346068,  0.32584 ,  0.292116,
            0.237242,  0.177095,  0.133722,  0.114828,  0.107722,  0.105237,
            0.103062,  0.103936,  0.10822 ,  0.110854,  0.113821,  0.119352,
            0.125094,  0.130511,  0.13756 ,  0.141072,  0.148131,  0.151362,
            0.157968,  0.163304,  0.169318,  0.175332,  0.183229,  0.188858,
            0.196828,  0.200256,  0.206229,  0.209918,  0.215939,  0.216284,
            0.217029,  0.223161,  0.228119,  0.228136,  0.228937,  0.231048,
            0.22639 ,  0.222758,  0.211126,  0.212616,  0.204018,  0.198309,
            0.197018,  0.183851,  0.175898,  0.177844,  0.172218,  0.165224,
            0.159219,  0.157794,  0.153081,  0.149086,  0.145368,  0.1353  ,
            0.125538,  0.116101,  0.107073,  0.106652,  0.105121,  0.103316,
                 np.nan,       np.nan,       np.nan,       np.nan,       np.nan,       np.nan,
                 np.nan,       np.nan,       np.nan,       np.nan,       np.nan,       np.nan])

    def test_read_usgs_file(self):
        s = extract_spectra_from_file(os.path.join(TEST_INPUTS_DIRECTORY, "russianolive.dw92-4.30728.asc"), 'usgs')

        assert_allclose(s.wavelengths, self.correct_wavelengths)
        assert_allclose(s.values, self.correct_values)

    def test_read_usgs_url(self):
        s = extract_spectra_from_file("http://speclab.cr.usgs.gov/spectral.lib06/ds231/ASCII/V/russianolive.dw92-4.30728.asc", 'usgs')

        assert_allclose(s.wavelengths, self.correct_wavelengths)
        assert_allclose(s.values, self.correct_values)
